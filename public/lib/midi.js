// MIDIjs - http://www.midijs.net 
//
// 100% JavaScript MIDI File Player using W3C Web Audio API 
// with fallbacks for older browsers
// 
// Copyrights Johannes Feulner, Karlsruhe, Germany, 2014. All rights reserved.
// Contact: weblily@weblily.net
//
//  Copyrights scorio GmbH, Pfinztal, Germany 2017. All rights reserved.
(function(e){function b(){var e=navigator.appVersion,t=navigator.userAgent,n=navigator.appName,r=""+parseFloat(navigator.appVersion),i=parseInt(navigator.appVersion,10),s,o,u;(o=t.indexOf("Opera"))!=-1?(n="Opera",r=t.substring(o+6),(o=t.indexOf("Version"))!=-1&&(r=t.substring(o+8))):(o=t.indexOf("MSIE"))!=-1?(n="Microsoft Internet Explorer",r=t.substring(o+5)):(o=t.indexOf("Trident"))!=-1?(n="Microsoft Internet Explorer",(o=t.indexOf("rv:"))!=-1?r=t.substring(o+3):r="0.0"):(o=t.indexOf("Chrome"))!=-1?(n="Chrome",r=t.substring(o+7)):(o=t.indexOf("Android"))!=-1?(n="Android",r=t.substring(o+8)):(o=t.indexOf("Safari"))!=-1?(n="Safari",r=t.substring(o+7),(o=t.indexOf("Version"))!=-1&&(r=t.substring(o+8))):(o=t.indexOf("Firefox"))!=-1?(n="Firefox",r=t.substring(o+8)):(s=t.lastIndexOf(" ")+1)<(o=t.lastIndexOf("/"))&&(n=t.substring(s,o),r=t.substring(o+1),n.toLowerCase()==n.toUpperCase()&&(n=navigator.appName)),(u=r.indexOf(";"))!=-1&&(r=r.substring(0,u)),(u=r.indexOf(" "))!=-1&&(r=r.substring(0,u)),i=parseInt(""+r,10),isNaN(i)&&(r=""+parseFloat(navigator.appVersion),i=parseInt(navigator.appVersion,10));var a=new Object;return a.browserName=n,a.fullVersion=r,a.majorVersion=i,a.appName=navigator.appName,a.userAgent=navigator.userAgent,a.platform=navigator.platform,a}function w(e,t){var n=document.getElementsByTagName("script")[0],r=document.createElement("script");r.onreadystatechange=function(){if(r.readyState==="loaded"||r.readyState==="complete")r.onreadystatechange=null,t()},r.onload=function(){t()},r.onerror=function(){j("Error: Cannot load  JavaScript filet "+e);return},r.src=e,r.type="text/javascript",n.parentNode.insertBefore(r,n)}function E(e){var t=new Object;0==v&&(v=n.currentTime),t.time=n.currentTime-v,MIDIjs.player_callback(t),c=Module.ccall("mid_song_read_wave","number",["number","number","number","number"],[h,f,u*2,g]);if(0==c){A();return}var r=Math.pow(2,15);for(var i=0;i<u;i++)i<c?e.outputBuffer.getChannelData(0)[i]=Module.getValue(f+2*i,"i16")/r:e.outputBuffer.getChannelData(0)[i]=0;a++,u*a/44100<t.time&&j("Wave: "+a+" Too slow: "+u*a/44100+" < "+t.time)}function S(e,t,i){var s=new XMLHttpRequest;s.open("GET",t+i,!0),s.responseType="arraybuffer",s.onerror=function(){j("Error: Cannot retrieve patch file "+t+i)},s.onload=function(){if(200!=s.status){j("Error: Cannot retrieve patch filee "+t+i+" : "+s.status);return}num_missing--,FS.createDataFile("pat/",i,new Int8Array(s.response),!0,!0),j("Loading instruments: "+num_missing);if(num_missing==0){stream=Module.ccall("mid_istream_open_mem","number",["number","number","number"],[l,midiFileArray.length,!1]);var o=32784,a=Module.ccall("mid_create_options","number",["number","number","number","number"],[n.sampleRate,o,1,u*2]);h=Module.ccall("mid_song_load","number",["number","number"],[stream,a]),rval=Module.ccall("mid_istream_close","number",["number"],[stream]),Module.ccall("mid_song_start","void",["number"],[h]),r=n.createScriptProcessor(u,0,1),f=Module._malloc(u*2),r.onaudioprocess=E,r.connect(n.destination),v=0,j("Playing: "+e+" ...")}},s.send()}function x(){var e=n.createBuffer(1,44100,44100);freq=440;for(i=0;i<48e3;i++)e.getChannelData(0)[i]=0;var t=n.createBufferSource();t.buffer=e,t.connect(n.destination),t.start(0)}function T(e){A(),g=!1,u=o,N(e)}function N(e){a=0,libtimidity_url=p+"libtimidity.js";for(var t=0;t<document.scripts.length;t++){var n=document.scripts[t].src;if(libtimidity_url==n){C(e);return}}j("Loading libtimidity ... "),(navigator.platform=="iPad"||navigator.platform=="iPhone"||navigator.platform=="iPod")&&x(),w(libtimidity_url,function(){C(e)})}function C(e){j("Loading MIDI file "+e+" ...");var t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer",t.onerror=function(){j("Error: Cannot retrieve MIDI file "+e)},t.onload=function(){if(200!=t.status){j("Error: Cannot retrieve MIDI file "+e+" : "+t.status);return}j("MIDI file loaded: "+e),midiFileArray=new Int8Array(t.response),l=Module._malloc(midiFileArray.length),Module.writeArrayToMemory(midiFileArray,l),rval=Module.ccall("mid_init","number",[],[]),stream=Module.ccall("mid_istream_open_mem","number",["number","number","number"],[l,midiFileArray.length,!1]);var i=32784,s=Module.ccall("mid_create_options","number",["number","number","number","number"],[n.sampleRate,i,1,u*2]);h=Module.ccall("mid_song_load","number",["number","number"],[stream,s]),rval=Module.ccall("mid_istream_close","number",["number"],[stream]),num_missing=Module.ccall("mid_song_get_num_missing_instruments","number",["number"],[h]);if(0<num_missing)for(var o=0;o<num_missing;o++){var a=Module.ccall("mid_song_get_missing_instrument","string",["number","number"],[h,o]);S(e,p+"pat/",a)}else Module.ccall("mid_song_start","void",["number"],[h]),r=n.createScriptProcessor(u,0,1),f=Module._malloc(u*2),r.onaudioprocess=E,r.connect(n.destination),v=0,j("Playing: "+e+" ...")},t.send()}function k(e,t,n){g||(g=!0,u=s,N(p+"../midi/initsynth.midi")),h!=0&&Module.ccall("mid_song_note_on","void",["number","number","number","number"],[h,e,t,n])}function L(){MIDIjs.noteOn(0,60,0)}function A(){r&&(r.disconnect(),r.onaudioprocess=0,r=0,Module._free(f),Module._free(l),Module.ccall("mid_song_free","void",["number"],[h]),h=0,Module.ccall("mid_exit","void",[],[]),r=0),j(m);var e=new Object;e.time=0,MIDIjs.player_callback(e)}function O(e){return d||(d=document.createElement("a")),d.href=e,d.href}function M(e){if("http:"==location.protocol.toLowerCase())return e;var t=O(e),n=t.replace("https:","http:");return n}function _(e){D(),e=M(e);var t=document.getElementById("scorioMIDI");t?t.lastChild.setAttribute("src",e):(t=document.createElement("div"),t.setAttribute("id","scorioMIDI"),t.innerHTML='&nbsp;<bgsound src="'+e+'" volume="100"/>',document.body.appendChild(t)),r=t,j("Playing "+e+" ...")}function D(){if(r){var e=r;e.lastChild.setAttribute("src","midi/silence.mid"),r=0}j(m)}function P(e){H();var t=document.getElementById("scorioMIDI");t?t.lastChild.setAttribute("data",e):(t=document.createElement("div"),t.setAttribute("id","scorioMIDI"),t.innerHTML='<object data="'+e+'" autostart="true" volume="100" type="audio/mid"></object>',document.body&&document.body.appendChild(t)),r=t,j("Playing "+e+" ...")}function H(){if(r){var e=r;e.parentNode.removeChild(e),r=0}j(m)}function B(){for(var e=0;e<document.scripts.length;e++){var t=document.scripts[e].src,n=t.lastIndexOf("midi.js");if(n==t.length-7)return t.substr(0,n)}return null}function j(e){y&&console.log(e)}var t,n=0,r=0,s=512,o=2048,u=o,a,f,l,c=0,h=0,p="",d,v=0,m="",g=!1,y=!1;p=B();var F=b();try{(F.platform=="iPhone"||F.platform=="iPod"||F.platform=="iPad")&&F.majorVersion<=6?t="none":(window.AudioContext=window.AudioContext||window.webkitAudioContext,n=new AudioContext,t="WebAudioAPI")}catch(I){F.browserName=="Microsoft Internet Explorer"?t="bgsound":F.browserName=="Android"?t="none":t="object"}e.MIDIjs=new Object,e.MIDIjs.set_logging=function(e){y=e},e.MIDIjs.get_loggging=function(){return y},e.MIDIjs.player_callback=function(e){return},e.MIDIjs.get_audio_status=function(){return m},e.MIDIjs.unmute_iOS_hack=x,t=="WebAudioAPI"?(e.MIDIjs.play=T,e.MIDIjs.stop=A,m="audioMethod: WebAudioAPI, sampleRate (Hz): "+n.sampleRate+", audioBufferSize (Byte): "+u,e.MIDIjs.noteOn=k,e.MIDIjs.startSynth=L):t=="bgsound"?(e.MIDIjs.play=_,e.MIDIjs.stop=D,m="audioMethod: &lt;bgsound&gt;"):t=="object"?(e.MIDIjs.play=P,e.MIDIjs.stop=H,m="audioMethod: &lt;object&gt;"):(e.MIDIjs.play=function(e){},e.MIDIjs.stop=function(e){},m="audioMethod: No method found"),F.browserName=="Microsoft Internet Explorer"&&"https:"==location.protocol.toLowerCase()&&_("http://"+p+"midi/silence.mid")})(this);
